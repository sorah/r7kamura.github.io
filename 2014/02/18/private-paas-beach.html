<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>Private PaaS Beach - r7kamura per second</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1394610828" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/r7kamura.png?1394610828" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            r7kamura per second
          </h1>
          <p class="header-text-description">
            Bits of technologies piled up here and there.
          </p>
        </div></a>
        
      </div>
    </header>
    <div class="main">
      <div class="main-inner main-inner-single-article"><article class="main-article">
  <div class="main-article-header">
    <h1 class="main-article-header-title">
      Private PaaS Beach
    </h1>
    <div class="main-article-header-date">
      2014-02-18
    </div>
  </div><h2>Dokku</h2>

<p><a href="https://github.com/progrium/dokku/">https://github.com/progrium/dokku/</a><br>
Dokkuを使えばmini-Herokuのような環境を簡単に構築出来る。
Dokkuを利用して構築したホストに対してgit pushでコードをデプロイすると、
HerokuのBuildpacksの仕組みを利用して環境が構築され、
Dockerのコンテナ上でアプリが起動し、nginxの設定が更新される。
Dokkuのホスト上でnginxがHTTPリクエストを待ち受けており、
サブドメインを元に適切なコンテナにリクエストを渡すという仕組みになっている。</p>

<h2>Digital Ocean</h2>

<p><a href="https://www.digitalocean.com/?refcode=3eaa05dda32a">https://www.digitalocean.com/</a><br>
Dokkuを試しに使ってみるにはDigital Oceanを利用するのが便利。
最初からDokkuがインストールされた状態のイメージが用意されていること、
1時間毎の都度課金なので使わないときにはスナップショットを撮って削除しておけば良いこと、
月5$で安い割にSSDが付いていて性能が良いこと、日本に近いシンガポールリージョンがあること、
10$分無料のクーポンコード(SSD2014)があること、Dokkuの構築完了まで全てブラウザだけで完結すること、
などがDigital Oceanが便利な部分。以下の手順で環境構築は完了、好きなアプリをデプロイし放題です。</p>

<ol>
<li>Sign Upする</li>
<li>クレカ情報を登録する</li>
<li>SSH公開鍵を登録する</li>
<li>Dokkuインストール済みのDroplet(=インスタンス)を作成する</li>
<li>DropletのIPアドレス(=Dokkuの初期設定画面)をブラウザで開く</li>
</ol>

<h2>デプロイ</h2>

<p>HerokuのBuildpackに対応している形式のアプリであれば何でもデプロイできる。
以下の例では、試しにRackアプリを置いてみている。
Rackアプリをつくる場合には、Gemfile、Gemfile.lock、config.ruがあれば良い。
<code>dokku@&lt;DropletのIPアドレス&gt;:&lt;任意のアプリ名&gt;</code>にgit pushすればデプロイされる。
今回独自ドメインを設定していないのでIPアドレスとポート番号になっているけれど、
自分でドメインを設定すればアプリごとに別々のサブドメインが割り振られるようになる。</p>

<pre><code>$ mkdir tinyrack
$ cd tinyrack
$ echo &#39;source &quot;https://rubygems.org&quot;&#39; &gt;&gt; Gemfile
$ echo &#39;gem &quot;rack&quot;&#39; &gt;&gt; Gemfile
$ echo &#39;run ->(*) { [200, {}, [&quot;Hello, world\\n&quot;]] }&#39; &gt;&gt; config.ru
$ bundle install
$ git init
$ git add .
$ git commit -m &quot;Initial commit&quot;
$ git push dokku@127.199.238.184:tinyrack master
$ curl http://127.199.238.184:49156
Hello, world
</code></pre>

<h2>DockerUI</h2>

<p><a href="https://github.com/crosbymichael/dockerui">https://github.com/crosbymichael/dockerui</a><br>
DockerUIというDocker管理用のアプリをDokku上にデプロイしておくと、Dockerの様子がブラウザで確認出来て便利。
DockerのプロセスはREST APIを持ったHTTPサーバを起動させており、HTTP経由でDockerを操作することが出来る。
DockerUIはHTML/CSS/JavaScriptで作られていて、JavaScriptからDockerのAPIにアクセスすることで管理画面を実現している。
認証機能が無いので、インターネットからアクセス出来る場所に置く場合は自分で設定する必要がある。
DockerUIの他には<a href="https://github.com/shipyard/shipyard">Shipyard</a>などのツールがある。</p>

<pre><code>$ ssh root@127.199.238.184
&gt; echo &#39;DOCKER_OPTS=&quot;-H unix:///var/run/docker.sock -H tcp://0.0.0.0:4243 -api-enable-cors&quot;&#39; &gt;&gt; /etc/default/docker
&gt; restart docker
&gt; exit
$ git clone git@github.com:crosbymichael/dockerui.git
$ cd dockerui
$ git push dokku@127.199.238.184:dockerui master
$ ssh dokku@127.199.238.184 config:set dockerui DOCKER_ENDPOINT=http://127.199.238.184:4243
$ open http://127.199.238.184:49154
</code></pre>

<p><img src="/images/2014-02-18/dockerui.png" alt=""></p>

<h2>最初から動く環境</h2>

<p>最初は手元のMac OSX上でDokkuを動かそうとしたのだけど、
久しぶりにMacでDockerを動かそうとして、そもそも最近DockerがMacをサポートしたという件について調べたり、
その件についてドキュメントが少なくて困ったり、実際にやってみたところ上手く動かせなかったり、
Vagrantを入れ直してDockerが動くUbuntuのイメージを取得し直したり、
Dokkuのセットアップ用のコードが上手く動かなかったり、
MacとVagrantとDockerの間のPort Forwardingが問題なのか自分のやっていることが問題なのか分からなかったりした。
人生は短い。</p>

</article>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013-2014 by <a target="_blank" href="http://twitter.com/r7kamura">@r7kamura</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://travis-ci.org/r7kamura/r7kamura.github.io">Travis CI</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>