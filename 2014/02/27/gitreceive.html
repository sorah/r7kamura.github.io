<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>Gitreceive - r7kamura per second</title><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><link href="/stylesheets/all.css?1394610828" media="all" rel="stylesheet" type="text/css" /><link href="/images/favicon.ico" rel="icon" type="image/ico" />
  </head>
  <body>
    <header class="header">
      <div class="header-inner"><a href="/">
        <div class="header-image">
          <img width="100" height="100" class="header-image-element" src="/images/r7kamura.png?1394610828" />
        </div>
        <div class="header-text">
          <h1 class="header-text-title">
            r7kamura per second
          </h1>
          <p class="header-text-description">
            Bits of technologies piled up here and there.
          </p>
        </div></a>
        
      </div>
    </header>
    <div class="main">
      <div class="main-inner main-inner-single-article">
        <article class="main-article">
          <div class="main-article-header">
            <h1 class="main-article-header-title">
              Gitreceive
            </h1>
            <div class="main-article-header-date">
              2014-02-27
            </div>
          </div>
          <p><a href="https://github.com/progrium/gitreceive">gitreceive</a>
          という、git push時に任意の処理を実行する為のツールがある。
          <a href="http://r7kamura.github.io/2014/02/18/private-paas-beach.html">Dokku</a>
          の中で同様の仕組みが使われており、
          git push時にbuildpacksでアプリをbuildしDockerコンテナの中で動かす、
          という機能を実現している。</p>
          
          <h2>認証機能</h2>
          
          <p>gitreceiveはSSH公開鍵登録用インターフェース、
          及び公開鍵を利用した簡易的な認証機能を持っているが、
          公開鍵を登録したユーザからのPushのみを許可するというもので、
          Pushするアプリケーションごとに別々の権限を与えるということは出来ない。</p>
          
          <h2>forced command</h2>
          
          <p>gitreceiveはSSHのforced commandと呼ばれる機能を利用している。
          forced commandを使うと「SSH接続時に何をするか」という情報を、
          クライアント側ではなくサーバ側で指定出来る。
          OpenSSHでは、authorized_keysに実行したいコマンドを指定することで実現出来る。
          gitreceiveはSSH公開鍵の登録時にforced commandを使い、
          git pushによりSSH接続が行われた際に
          /home/${GITUSER}/gitreceive を実行している。
          Dokkuでは、このタイミングで /user/local/bin/dokku を実行している。</p>
          
          <h2>Receiver</h2>
          
          <p>gitreceiveにより実行されるファイルをReceiverと呼ぶ。
          Receiverには、Pushされたレポジトリ名、リビジョン、ユーザ名などが引数で渡され、
          Pushされたデータの内容は標準入力で受け取れる。
          gitreceiveのREADMEでは、git push時にHTTPリクエストを送る例を紹介している。
          Receiverの内容を変更することで、
          例えばモニタリングに利用したり、
          DokkuのようにDockerコンテナにアプリをデプロイしたりということが可能になる。</p>
          
          <h2>gitreceive-next</h2>
          
          <p>gitreceiveの次期バージョンとして、現在
          <a href="https://github.com/flynn/gitreceive-next">gitreceive-next</a>
          が開発されている。
          gitreceiveはSSHのフックを設定するための単純なShellScriptだったが、
          gitreceive-nextはGo言語製のSSHサーバとして実装されている。
          主な用途はgit pushを待ち受けることではあるものの
          Gitに依存する処理はほぼ取り除かれており、
          起動時に指定された実行ファイルに対してSSH接続を委譲するための認証機能付きリバースプロキシ、というような存在になっている。
          今後は権限やルーティング管理、複数ノード間での設定共有などの機能を追加予定とのこと。</p>
          
        </article>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-inner">
        <p class="footer-copyright">
          Copyright &copy; 2013-2014 by <a target="_blank" href="http://twitter.com/r7kamura">@r7kamura</a>
        </p>
        <p class="footer-powers">
          Powered by <a href="https://github.com/r7kamura/r7kamura.github.io">Github</a> & <a href="https://travis-ci.org/r7kamura/r7kamura.github.io">Travis CI</a> & <a href="https://github.com/r7kamura/sitespec">Sitespec</a>
        </p>
      </div>
    </footer>
  </body>
</html>